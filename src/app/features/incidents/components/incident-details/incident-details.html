<!-- incident-details.html -->
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      <div class="card border-0 shadow-lg">

        <!-- Header -->
        <div class="card-header bg-gradient-info text-white border-0 py-3">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <h3 class="badge bg-white text-dark ms-3 fs-4 py-2 px-3 d-flex align-items-center gap-2">
                <i class="bi bi-file-text-fill fs-3"></i>
                #{{ incident.ticketNumber }}
              </h3>
            </div>
          </div>
        </div>

        <div class="card-body p-4">

          <!-- Basic Information (Read-only) -->
          <div class="row mb-4">
            <div class="col-12">
              <h4 class="text-dark mb-3 border-bottom pb-2">
                <i class="bi bi-info-circle-fill text-info me-2"></i>
                Basic Information
              </h4>
            </div>

            <!-- Title -->
            <div class="col-md-3 mb-3">
              <label class="form-label text-muted fw-semibold small">TITLE</label>
              <div class="info-display">
                <i class="bi bi-card-heading text-primary me-2"></i>
                <span class="fs-5 fw-semibold">{{ incident.title }}</span>
              </div>
            </div>

            <!-- Created Date -->
            <div class="col-md-3 mb-3">
              <label class="form-label text-muted fw-semibold small">CREATED</label>
              <div class="info-display">
                <i class="bi bi-calendar-plus text-success me-2"></i>
                <span>{{ formatDate(incident.createdOn) }}</span>
              </div>
            </div>

            <!-- Client Info -->
            <div class="col-md-3 mb-3">
              <label class="form-label text-muted fw-semibold small">CLIENT</label>
              <div class="info-display">
                <i class="bi me-2" [class]="getClientTypeIcon(incident.clientType)"
                   [class.text-info]="incident.clientType === ClientType.Contact"
                   [class.text-warning]="incident.clientType === ClientType.Account"></i>
                <span class="fw-medium">{{ clientName }}</span>
                <span class="badge badge-outline-secondary ms-2">
                  {{ getClientTypeLabel(incident.clientType) }}
                </span>
              </div>
            </div>

            <!-- Origin -->
            <div class="col-md-3 mb-3">
              <label class="form-label text-muted fw-semibold small">ORIGIN</label>
              <div class="info-display">
                <i class="bi me-2"
                   [class]="getOriginOption(incident.origin)?.icon"
                   [class.text-info]="getOriginOption(incident.origin).class.includes('info')"
                   [class.text-primary]="getOriginOption(incident.origin).class.includes('primary')"
                   [class.text-success]="getOriginOption(incident.origin).class.includes('success')"></i>
                <span>{{ getOriginOption(incident.origin)?.label }}</span>
              </div>
            </div>
          </div>

          <!-- Editable Fields Section -->
          <div class="row">
            <div class="col-12">
              <h4 class="text-dark mb-3 border-bottom pb-2">
                <i class="bi bi-gear-fill text-warning me-2"></i>
                Details
                @if (isEditing) {
                  <small class="text-muted ms-2">(Click save to apply changes)</small>
                }
              </h4>
            </div>
          </div>

          @if (isEditing) {
            <form [formGroup]="editForm" (ngSubmit)="saveChanges()">
              <div class="row">

                <!-- Priority (Edit Mode) -->
                <div class="col-md-4 mb-4">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-flag-fill text-danger me-1"></i>Priority *
                  </label>
                  <select
                    class="form-select"
                    [class.is-invalid]="isFieldInvalid('priority')"
                    formControlName="priority">
                    @for (option of priorityOptions; track option.value) {
                      <option [value]="option.value">{{ option.label }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('priority')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('priority') }}
                    </div>
                  }
                </div>

                <!-- Status (Edit Mode) -->
                <div class="col-md-4 mb-4">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-info-circle-fill text-primary me-1"></i>Status *
                  </label>
                  <select
                    class="form-select"
                    [class.is-invalid]="isFieldInvalid('status')"
                    formControlName="status">
                    @for (option of statusOptions; track option.value) {
                      <option [value]="option.value">{{ option.label }}</option>
                    }
                  </select>
                  @if (isFieldInvalid('status')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('status') }}
                    </div>
                  }
                </div>

                <div class="col-md-4 mb-4 d-flex align-items-end">
                  <div class="d-flex gap-2 w-100">
                    <button
                      type="button"
                      class="btn btn-outline-secondary flex-fill"
                      (click)="toggleEdit()"
                      [disabled]="isLoading">
                      <i class="bi bi-x-lg me-1"></i>Cancel
                    </button>

                    <button
                      type="submit"
                      class="btn btn-success flex-fill"
                      [disabled]="editForm.invalid || isLoading || !hasFormChanges()">

                      @if (isLoading) {
                        <span class="spinner-border spinner-border-sm me-2"></span>
                      }
                      @if (!isLoading) {
                        <i class="bi bi-check-lg me-1"></i>
                      }
                      {{ isLoading ? 'Saving...' : 'Save Changes' }}
                    </button>
                  </div>
                </div>

                <!-- Description (Edit Mode) -->
                <div class="col-12 mb-4">
                  <label class="form-label fw-semibold">
                    <i class="bi bi-chat-text text-info me-1"></i>Description
                  </label>
                  <textarea
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid('description')"
                    formControlName="description"
                    rows="4"
                    placeholder="Add or update incident description..."
                    maxlength="1000"></textarea>
                  <div class="form-text d-flex justify-content-between">
                    <span>Provide additional context or updates</span>
                    <span class="text-muted">
                    {{ editForm.get('description')?.value?.length || 0 }}/1000
                  </span>
                  </div>
                  @if (isFieldInvalid('description')) {
                    <div class="invalid-feedback">
                      {{ getFieldError('description') }}
                    </div>
                  }
                </div>

              </div>
            </form>
          } @else {
            <!-- Read-only View -->
            <div class="row">

            <!-- Priority (Read-only) -->
            <div class="col-md-4 mb-4">
              <label class="form-label text-muted fw-semibold small">PRIORITY</label>
              <div class="info-display-card"
                   [class]="getPriorityOption(incident.priority)?.bgClass">
                <i class="bi me-2"
                   [class]="getPriorityOption(incident.priority)?.icon"
                   [class.text-danger]="getPriorityOption(incident.priority).class.includes('danger')"
                   [class.text-warning]="getPriorityOption(incident.priority).class.includes('warning')"
                   [class.text-success]="getPriorityOption(incident.priority).class.includes('success')"></i>
                <span class="fw-semibold">{{ getPriorityOption(incident.priority)?.label }}</span>
              </div>
            </div>

            <!-- Status (Read-only) -->
            <div class="col-md-4 mb-4">
              <label class="form-label text-muted fw-semibold small">STATUS</label>
              <div class="info-display-card"
                   [class]="getStatusOption(incident.status)?.bgClass">
                <i class="bi me-2"
                   [class]="getStatusOption(incident.status)?.icon"
                   [class.text-primary]="getStatusOption(incident.status).class.includes('primary')"
                   [class.text-warning]="getStatusOption(incident.status).class.includes('warning')"
                   [class.text-info]="getStatusOption(incident.status).class.includes('info')"
                   [class.text-secondary]="getStatusOption(incident.status).class.includes('secondary')"
                   [class.text-success]="getStatusOption(incident.status).class.includes('success')"
                   [class.text-danger]="getStatusOption(incident.status).class.includes('danger')"></i>
                <span class="fw-semibold">{{ getStatusOption(incident.status).label }}</span>
              </div>
            </div>

            <!-- Edit Button Placeholder for Layout -->
            @if (!readonly) {
              <div class="col-md-4 mb-4 d-flex align-items-end">
                <button
                  type="button"
                  class="btn btn-outline-primary w-100"
                  (click)="toggleEdit()">
                  <i class="bi bi-pencil-square me-2"></i>Edit Details
                </button>
              </div>
            }
            <!-- Description (Read-only) -->
            <div class="col-12 mb-4">
              <label class="form-label text-muted fw-semibold small">DESCRIPTION</label>
              <div class="description-display"
                   [class.empty-description]="!incident.description">
                @if (incident.description) {
                  <div class="p-3 rounded-3 bg-light border">
                    <i class="bi bi-chat-text text-info me-2"></i>
                    <span [innerHTML]="incident.description | slice:0:500"></span>
                    @if (incident.description.length > 500) {
                      <span class="text-muted">... (truncated)</span>
                    }
                  </div>
                } @else {
                  <div class="text-muted fst-italic p-3 rounded-3 bg-light border">
                    <i class="bi bi-chat text-muted me-2"></i>
                    No description provided
                  </div>
                }
              </div>
            </div>

            </div>
          }

        </div>
      </div>
    </div>
  </div>
</div>
